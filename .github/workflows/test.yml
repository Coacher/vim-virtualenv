name: Test virtual environment activation

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        tool: [ "venv", "virtualenv" ]
        kind: [ "internal", "external" ]

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12" # Vim on Ubuntu supports only 3.12

      - name: Set up tools
        run: |
          python -m pip install --upgrade virtualenv

      - name: Set up Vim
        run: |
          sudo apt-get update
          sudo apt-get install --yes vim

      - name: Create virtual environment
        run: |
          export VIM_VIRTUALENV_TARGET="$(mktemp --directory)"
          python -m ${{ matrix.tool }} "${VIM_VIRTUALENV_TARGET}"
          echo "VIM_VIRTUALENV_TARGET=${VIM_VIRTUALENV_TARGET}" >> "${GITHUB_ENV}"

      - name: Activate virtual environment
        run: |
          if [[ "${{ matrix.kind }}" -eq "internal" ]];
            then cd "${VIM_VIRTUALENV_TARGET}"; \
            else source "${VIM_VIRTUALENV_TARGET}/bin/activate"; \
          fi
          MATRIX_KIND_CODE=$([[ "${{ matrix.kind }}" -eq "internal" ]] && echo 1 || echo 0)
          vim --not-a-term -u "${GITHUB_WORKSPACE}/.github/workflows/vimrc.github" \
            -c "call assert_equal('${{ matrix.tool }}', virtualenv#state('virtualenv_type'))" \
            -c "call assert_equal(${MATRIX_KIND_CODE}, virtualenv#state('virtualenv_internal'))" \
            -c "call assert_equal('${VIM_VIRTUALENV_TARGET}', virtualenv#state('virtualenv_directory'))" \
            -c "call g:ExitTest()"
